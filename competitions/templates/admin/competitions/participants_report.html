{% extends "admin/base_site.html" %}
{% load static jalali_filters %}

{% block title %}Ù„ÛŒØ³Øª Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù† Ù…Ø³Ø§Ø¨Ù‚Ø§Øª{% endblock %}

{% block content %}
<div dir="rtl" class="tkd-report" style="text-align:right">
  <h1 class="tkd-title">Ù„ÛŒØ³Øª Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù† Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</h1>

  <!-- ÙØ±Ù… Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø³Ø§Ø¨Ù‚Ù‡ (Ø¯Ø± Ú†Ø§Ù¾ Ù…Ø®ÙÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯) -->
  <form method="get" class="module tkd-form">
    <fieldset class="tkd-fieldset">
      {{ form.competition.label_tag }}
      {{ form.competition }}
      <button type="submit" class="button">Ù†Ù…Ø§ÛŒØ´</button>
    </fieldset>
  </form>

  {% if selected_competition %}

    <div class="module aligned tkd-box">
      <div class="tkd-banner">Ù…Ø³Ø§Ø¨Ù‚Ù‡: {{ selected_competition.title }}</div>
      <p class="tkd-hint">ØªÙÚ©ÛŒÚ© Ø¨Ø± Ø§Ø³Ø§Ø³ Ú¯Ø±ÙˆÙ‡ Ú©Ù…Ø±Ø¨Ù†Ø¯ÛŒ Ùˆ Ø±Ø¯Ù‡Ù” ÙˆØ²Ù†ÛŒ</p>

      {# ÙØ±Ù… POST Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ #}
      <form method="post" id="participants-form">
        {% csrf_token %}
        <input type="hidden" name="competition" value="{{ selected_competition.id }}">
        <input type="hidden" name="delete_selected" value="1">

        {% if groups %}
          {% for belt_label, weight_rows in groups %}
            <div class="module tkd-section">
              <div class="tkd-section__head">Ú¯Ø±ÙˆÙ‡ Ú©Ù…Ø±Ø¨Ù†Ø¯ÛŒ: {{ belt_label }}</div>

              {% for weight_label, enrolls in weight_rows %}
                <div class="tkd-weight-block">

                  {# --- Ù‡Ø¯Ø± Ù…Ø®ØµÙˆØµ Ú†Ø§Ù¾ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒÙ† Ø±Ø¯Ù‡ --- #}
                  <header class="print-only print-header">
                    <img class="print-logo" src="{% static 'img/logo512.png' %}" alt="logo">
                    <div class="print-meta">
                      <div class="print-title">{{ selected_competition.title }}</div>
                      <div class="print-sub">
                        Ú¯Ø±ÙˆÙ‡ Ú©Ù…Ø±Ø¨Ù†Ø¯ÛŒ: {{ belt_label }} &nbsp;|&nbsp; Ø±Ø¯Ù‡ ÙˆØ²Ù†ÛŒ: {{ weight_label }}
                      </div>
                    </div>
                  </header>

                  <h3 class="tkd-weight-title">Ø±Ø¯Ù‡ ÙˆØ²Ù†ÛŒ: {{ weight_label }}</h3>

                  <div class="results">
                    <table class="tkd-table">
                      <thead>
                        <tr>
                          <th class="tkd-select-col screen-only">Ø§Ù†ØªØ®Ø§Ø¨</th>
                          <th class="align-right">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</th>
                          <th>ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯</th>
                          <th>Ú©Ø¯ Ù…Ù„ÛŒ</th>
                          <th>Ú©Ù…Ø±Ø¨Ù†Ø¯</th>
                          <th>ÙˆØ²Ù† Ø§Ø¹Ù„Ø§Ù…ÛŒ</th>
                          <th>Ø´Ù…Ø§Ø±Ù‡ Ø¨ÛŒÙ…Ù‡</th>
                          <th>ØªØ§Ø±ÛŒØ® ØµØ¯ÙˆØ±</th>
                          <th class="align-right">Ù†Ø§Ù… Ù…Ø±Ø¨ÛŒ</th>
                          <th class="align-right">Ù†Ø§Ù… Ø¨Ø§Ø´Ú¯Ø§Ù‡</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for e in enrolls %}
                          <tr>
                            <td class="tkd-select-col screen-only">
                              <input type="checkbox"
                                     name="selected_enrollments"
                                     value="{{ e.id }}"
                                     class="tkd-select-checkbox">
                            </td>
                            <td class="align-right">{{ e.player.first_name }} {{ e.player.last_name }}</td>
                            <td class="fa-num">{{ e.player.birth_date|to_jalali|to_fa }}</td>
                            <td class="fa-num">{{ e.player.national_code|to_fa }}</td>
                            <td>{{ e.player.belt_grade|default:"â€”" }}</td>
                            <td class="fa-num">{{ e.declared_weight|default:"â€”"|to_fa }}</td>
                            <td class="fa-num">{{ e.insurance_number|default:"â€”"|to_fa }}</td>
                            <td class="fa-num">{{ e.insurance_issue_date|to_jalali|to_fa }}</td>
                            <td class="align-right">{{ e.coach_name|default:"â€”" }}</td>
                            <td class="align-right">{{ e.club_name|default:"â€”" }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endfor %}

          <div class="tkd-actions screen-only">
            <button type="button" class="button tkd-delete-btn" id="delete-selected-btn">
              ğŸ—‘ Ø­Ø°Ù Ù…ÙˆØ§Ø±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡
            </button>
            <button type="button" class="button tkd-print-btn" onclick="window.print()">
              ğŸ–¨ Ú†Ø§Ù¾ Ù„ÛŒØ³Øª
            </button>
          </div>

        {% else %}
          <p>Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
        {% endif %}
      </form>
    </div>
  {% endif %}
</div>

{# Ù…ÙˆØ¯Ø§Ù„ ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù #}
<div id="confirm-modal"
     class="screen-only"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45);
            align-items:center; justify-content:center; z-index:1000;">
  <div style="background:#fff; padding:20px 25px; border-radius:6px;
              min-width:280px; max-width:400px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
    <h2 style="margin-top:0; font-size:18px;">ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù</h2>
    <p style="margin:10px 0 18px;">
      Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ<br>
      Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.
    </p>
    <div style="margin-top: 10px; display:flex; gap:10px; justify-content:center;">
      <button type="button" class="button" id="confirm-delete-btn"
              style="background:#ba2121; border-color:#ba2121; color:#fff;">
        Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ø´ÙˆØ¯
      </button>
      <button type="button" class="button" id="cancel-delete-btn">
        Ø§Ù†ØµØ±Ø§Ù
      </button>
    </div>
  </div>
</div>

<script>
  (function() {
    const deleteBtn = document.getElementById("delete-selected-btn");
    const modal     = document.getElementById("confirm-modal");
    const confirm   = document.getElementById("confirm-delete-btn");
    const cancel    = document.getElementById("cancel-delete-btn");
    const form      = document.getElementById("participants-form");

    if (!deleteBtn || !modal || !confirm || !cancel || !form) {
      return;
    }

    deleteBtn.addEventListener("click", function() {
      const checked = document.querySelectorAll('input[name="selected_enrollments"]:checked');
      if (!checked.length) {
        alert("Ù‡ÛŒÚ† Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
        return;
      }
      modal.style.display = "flex";
    });

    cancel.addEventListener("click", function() {
      modal.style.display = "none";
    });

    confirm.addEventListener("click", function() {
      modal.style.display = "none";
      form.submit();
    });
  })();
</script>

<style>
  /* â€”â€”â€” Ø¸Ø§Ù‡Ø± ØµÙØ­Ù‡ (Ù…Ø«Ù„ Ù‚Ø¨Ù„) â€”â€”â€” */
  .tkd-title{margin:0 0 12px;}
  .tkd-form{padding:12px; margin-bottom:16px;}
  .tkd-fieldset{border:none; margin:0; padding:0; display:flex; gap:8px; align-items:center;}
  .tkd-box{padding:12px;}
  .tkd-banner{background:#6ba5c0; color:#fff; padding:10px 14px; border-radius:6px; margin-bottom:10px; font-weight:700;}
  .tkd-hint{color:#666;margin:0 0 8px;}
  .tkd-section{margin:16px 0; border:1px solid #cbd5e1; border-radius:10px; overflow:hidden;}
  .tkd-section__head{background:#e2ecf4; padding:10px 12px; font-weight:700; color:#0f3652;}
  .tkd-weight-block{padding:10px 12px; border-top:1px solid #e5e7eb;}
  .tkd-weight-title{margin:0 0 8px; font-size:14px; color:#0f3652;}

  .tkd-table{width:100%; border-collapse:separate; border-spacing:0; direction:rtl;}
  .tkd-table thead th{
    background:#e9f1f7; padding:10px 12px; text-align:center; font-weight:700; border:1px solid #cbd5e1;
  }
  .tkd-table tbody td{
    padding:10px 12px; text-align:center; vertical-align:middle; border:1px solid #e5e7eb; background:#fff;
  }
  .tkd-table tbody tr:nth-child(odd) td{ background:#fafafa; }

  .tkd-select-col{ width:40px; text-align:center; }

  .align-right{ text-align:right !important; }
  .fa-num{ direction: rtl; unicode-bidi: plaintext; font-variant-numeric: tabular-nums; white-space: nowrap; }

  .tkd-actions{ margin-top:16px; text-align:center; display:flex; gap:8px; justify-content:center; }
  .tkd-print-btn{ background:#16a34a; color:#fff; border:none; }
  .tkd-delete-btn{ background:#ba2121; color:#fff; border:none; }

  /* â€”â€”â€” Ù†Ù…Ø§ÛŒØ´/Ú†Ø§Ù¾ â€”â€”â€” */
  .print-only{ display:none; }
  .screen-only{ display:block; }

  @media print {
    /* Ø­Ø§Ø´ÛŒÙ‡ Ú©Ù… ØµÙØ­Ù‡ Ú†Ø§Ù¾ */
    @page { margin:4mm; }

    /* Ø­Ø°Ù ØªÙ…Ø§Ù… Ø¹Ù†Ø§ØµØ± Ø§Ø¶Ø§ÙÛŒ admin Ùˆ Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ */
    header, nav, #header, #branding, .breadcrumbs, #content > h1,
    .object-tools, .paginator, footer, .tkd-form,
    .screen-only, .tkd-title, .tkd-banner, .tkd-hint,
    .tkd-section__head, .tkd-weight-title {
      display: none !important;
    }

    html, body { margin:0 !important; padding:0 !important; background:#fff !important; }

    /* Ù‡Ø¯Ø± Ú†Ø§Ù¾ Ø¯Ø§Ø®Ù„ Ù‡Ø± Ø±Ø¯Ù‡ ÙˆØ²Ù†ÛŒ */
    .print-only{ display:flex !important; align-items:center; gap:10px; margin:2mm 0 3mm 0; }
    .print-logo{ width:44px; height:44px; object-fit:contain; }
    .print-meta{ display:flex; flex-direction:column; gap:2px; }
    .print-title{ font-weight:800; font-size:15px; }
    .print-sub{ font-size:13px; }

    /* Ø¬Ø¯ÙˆÙ„ Ú†Ø³Ø¨ÛŒØ¯Ù‡ Ø¨Ù‡ Ù‡Ø¯Ø± */
    .tkd-report, .tkd-box, .tkd-section, .tkd-weight-block { margin:0 !important; padding:0 !important; border:none !important; }
    .tkd-table{ margin:0 !important; width:100% !important; }

    /* Ø±Ù†Ú¯ Ù‡Ø¯Ø± Ø¬Ø¯ÙˆÙ„ Ø¯Ø± Ú†Ø§Ù¾ Ø­ÙØ¸ Ø´ÙˆØ¯ */
    .tkd-table thead th{
      background:#e9f1f7 !important;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }

    /* Ù‡Ø± Ø±Ø¯Ù‡ ÙˆØ²Ù†ÛŒ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² ØµÙØ­Ù‡â€ŒÛŒ Ø¬Ø¯ÛŒØ¯ */
    .tkd-weight-block{ page-break-inside: avoid; }
  }
</style>
{% endblock %}
