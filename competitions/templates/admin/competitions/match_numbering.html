{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Ø´Ù…Ø§Ø±Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§{% endblock %}

{% block extrahead %}
  {{ block.super }}
  {{ form.media }}
  <!-- html-to-image Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª PNG Ø§Ø² DOM -->
  <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>

  <style>
    :root{ --line-w:2px; --stroke:#444; --col-gap:88px; --hdrScale:1; --brand:#4f46e5; }

    .mn-wrap{direction:rtl;margin:14px}
    .mn-form{display:flex;flex-direction:column;gap:12px;max-width:980px}
    .mn-row{display:flex;align-items:center;gap:12px}
    .mn-actions{display:flex;align-items:center;gap:14px;margin-top:6px}
    .mn-result{margin-top:18px;padding:12px;background:#f6f6f6;border:1px solid #ddd;border-radius:8px}
    .byetip{font-size:12px;color:#666}
    .byetic{font-size:15px;color:#00ff0d}
    .byetid{font-size:15px;color:#ff0000}

    .mn-form select{min-width:280px}
    .mn-wrap > h1{ display:none !important; }

    /* Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø± Ø¨Ø§Ù„Ø§ÛŒ Ù†ØªØ§ÛŒØ¬ */
    .pd-toolbar{
      display:flex; align-items:center; gap:8px; justify-content:flex-end;
      margin:18px auto 6px; max-width:860px;
    }

    /* Ú©Ø§Ø±Øª */
    .cards{ display:flex; flex-direction:column; gap:24px; margin-top:18px; }
    .card{
      position:relative; border:1px solid #e6e6ef; border-radius:14px; background:#fff;
      width:860px; margin:0 auto; box-sizing:border-box; overflow:hidden;
    }

    /* Ù…Ø­ØªÙˆØ§/Ø¹Ú©Ø³ */
    .card-content{ display:block; }
    .card-snapshot{ display:none; width:100%; height:auto; }
    .card.is-snap .card-content{ display:none; }
    .card.is-snap .card-snapshot{ display:block; }

    /* Ù‡Ø¯Ø± */
    .card .hd{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 12px; background:#f7f8ff; border-bottom:1px solid #ececf4;
    }
    .card .hd .left{
      display:flex; flex-wrap:nowrap; gap:8px; align-items:center;
      transform:scale(var(--hdrScale)); transform-origin:right center;
    }
    .pill{ background:#eef2ff; border:1px solid #dbe1ff; padding:4px 10px; border-radius:999px; font-size:12px; white-space:nowrap; color:#4338ca; }
    .card .hd .brand-logo{ height:56px; width:auto; object-fit:contain; flex-shrink:0; }

    .card .bd{ padding:0; }

    /* Ø¨Ø±Ø¯ */
    .bubble.bye-mark{ background:linear-gradient(var(--stroke),var(--stroke)) center/70% 2px no-repeat,#fff !important; }
    .bracket-wrap .view{
      direction:ltr; width:827px; height:1130px; overflow:hidden; position:relative; box-sizing:border-box; background:#fff; display:block;
    }
    .bracket-wrap .board{
      transform:scale(var(--scale,0.62)); transform-origin:top left;
      width:max-content; display:flex; gap:var(--col-gap); justify-content:flex-start; align-items:flex-start; padding:0 14px 32px; margin:0; will-change:transform;
    }

    .player-input{
      background:#fff; border:2px solid var(--stroke); border-radius:8px; padding:9px 12px; text-align:center; font-size:21px; font-weight:bolder; height:70px; color:#111; width:190px; max-width:250px; direction:rtl; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; pointer-events:none;
    }
    .player-input[readonly]{ -webkit-text-fill-color:#000; }
    .bye{ opacity:.7; font-style:italic }
    .bubble{ position:absolute; top:-25px; width:35px; height:36px; border-radius:50%; border:2px solid var(--stroke); background:#fff; color:#000; text-align:center; font-size:33px; line-height:36px; transform:translateY(-50%); z-index:3; pointer-events:none; }
    .col{ display:flex; flex-direction:column; position:relative; }

    /* Ø±Ø§Ù†Ø¯Ù‡Ø§ (ØªØ§ Û³Û²) */
    .r1{ --box-h:46px; --gap-y:24px; --stub-len:35px; --stub-ext:60px; }
    .r1 .item{ position:relative; height:var(--box-h); }
    .r1 .stack{ display:flex; flex-direction:column; gap:var(--gap-y); }
    .r1 .item::before{ content:""; position:absolute; top:50%; transform:translateY(-50%); right:-35px; width:35px; height:0; border-top:var(--line-w) solid var(--stroke); }
    .r1 .item:nth-child(2n)::after{ content:""; position:absolute; top:-47px; height:calc(var(--box-h) + var(--gap-y)); right:-94px; width:calc(var(--line-w) + var(--stub-ext)); background:linear-gradient(var(--stroke),var(--stroke)) left 0/var(--line-w) 100% no-repeat, linear-gradient(var(--stroke),var(--stroke)) left 50%/calc(100% - var(--line-w)) var(--line-w) no-repeat; z-index:2; }
    .r1 .bubble{ top:-25% }
    .r2{ --box-h:46px; --gap-y:calc(2 * 24px + 46px); --stub-len:35px; --stub-ext:72px; margin-top:calc((46px + 24px)/2); }
    .r2 .item{ position:relative; height:var(--box-h); }
    .r2 .stack{ display:flex; flex-direction:column; gap:var(--gap-y); }
    .r2 .item::before{ content:""; position:absolute; top:105%; right:-35px; width:var(--stub-len); height:var(--line-w); background:var(--stroke); transform:translateY(-50%); z-index:2; }
    .r2 .item:nth-child(2n)::after{ content:""; position:absolute; top:-93px; height:calc(var(--box-h) + var(--gap-y)); right:-95px; width:62px; background:linear-gradient(var(--stroke),var(--stroke)) left 0/var(--line-w) 100% no-repeat, linear-gradient(var(--stroke),var(--stroke)) left 50%/calc(100% - var(--line-w)) var(--line-w) no-repeat; z-index:2; }
    .r2 .bubble{ top:-52%; right:-28px; }
    .r3{ --box-h:46px; --gap-y:calc(2*(46px + 24px) + 24px); --stub-len:35px; --stub-ext:84px; margin-top:calc((46px + 24px) + (46px + 24px)/2); }
    .r3 .item{ position:relative; height:var(--box-h); }
    .r3 .stack{ display:flex; flex-direction:column; gap:233px; }
    .r3 .item::before{ content:""; position:absolute; top:100%; right:-35px; width:var(--stub-len); height:var(--line-w); background:var(--stroke); transform:translateY(-50%); z-index:2; }
    .r3 .item:nth-child(2n)::after{ content:""; position:absolute; top:-235px; height:282px; right:-94px; width:59px; background:linear-gradient(var(--stroke),var(--stroke)) left 0/var(--line-w) 100% no-repeat, linear-gradient(var(--stroke),var(--stroke)) left 50%/calc(100% - var(--line-w)) var(--line-w) no-repeat; z-index:2; }
    .r3 .bubble{ top:-205% }
    .r4{ --box-h:46px; --gap-y:calc(2*((46px + 24px)*2 + 24px)); --stub-len:35px; --stub-ext:96px; margin-top:243px; }
    .r4 .item{ position:relative; height:var(--box-h); }
    .r4 .stack{ display:flex; flex-direction:column; gap:512px; }
    .r4 .item::before{ content:""; position:absolute; top:100%; right:-35px; width:var(--stub-len); height:var(--line-w); background:var(--stroke); transform:translateY(-50%); z-index:2; }
    .r4 .item:nth-child(2n)::after{ content:""; position:absolute; top:-513px; height:558px; right:-95px; width:62px; background:linear-gradient(var(--stroke),var(--stroke)) left 0/var(--line-w) 100% no-repeat, linear-gradient(var(--stroke),var(--stroke)) left 50%/calc(100% - var(--line-w)) var(--line-w) no-repeat; z-index:2; }
    .r4 .bubble{ top:-508%; }
    .r5{ --box-h:46px; --stub-len:35px; --stub-ext:110px; margin-top:520px; }
    .r5 .item{ position:relative; height:var(--box-h); }
    .r5 .stack{ display:flex; flex-direction:column; gap:1070px; }
    .r5 .item::before{ content:""; position:absolute; top:100%; right:-35px; width:var(--stub-len); height:var(--line-w); background:var(--stroke); transform:translateY(-50%); z-index:2; }
    .r5 .item:nth-child(2n)::after{ content:""; position:absolute; top:-1070px; height:1117px; right:-95px; width:62px; background:linear-gradient(var(--stroke),var(--stroke)) left 0/var(--line-w) 100% no-repeat, linear-gradient(var(--stroke),var(--stroke)) left 50%/calc(100% - var(--line-w)) var(--line-w) no-repeat; z-index:2; }
    .r5 .bubble{ top:-1114%; }
    .r6{ margin-top:1077px; }
    .r6 .champ{ position:relative; }
    .champ .player-input{ width:240px; font-weight:bold; }

    /* Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Øª (ÙÙ‚Ø· Ø¯Ø§Ù†Ù„ÙˆØ¯) */
    .card-controls{ display:flex; gap:8px; justify-content:flex-end; align-items:center; padding:10px 12px; border-top:1px solid #f0f0f7; }
    .card-controls .err{ color:#b91c1c; font-size:12px; }

    /* Ø§ÙˆØ±Ù„ÛŒ Ø§Ù†ØªØ¸Ø§Ø± */
    .snapshot-overlay{
      position:absolute; inset:0; background:rgba(0,0,0,.18);
      display:none; flex-direction:column; align-items:center; justify-content:center; z-index:50;
    }
    .card.is-rendering .snapshot-overlay{ display:flex; }
    .snapshot-overlay .wait-label{ margin-top:10px; color:#111; font-weight:700; background:#fff; padding:6px 10px; border-radius:10px; border:1px solid #ececec; }
    .spinner{ width:38px; height:38px; border-radius:50%; border:4px solid #ddd; border-top-color:var(--brand); animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
    .button{ cursor:pointer; border-radius:10px; padding:8px 14px; font-weight:600; border:1px solid #e5e7eb; background:#fff; }
    .button.default{ background:#4f46e5; border-color:#4f46e5; color:#fff; }
    .button.outline{ color:#4f46e5; border-color:#4f46e5; background:#fff; }
  </style>
{% endblock %}

{% block content %}
  <div class="mn-wrap">
    <form method="post" class="mn-form" id="mn-form">{% csrf_token %}
      <div class="mn-row">
        <label for="id_competition" style="min-width:110px">Ù…Ø³Ø§Ø¨Ù‚Ù‡:</label>
        {{ form.competition }}
      </div>

      <div>
        <label for="id_weights">Ø§ÙˆØ²Ø§Ù†ÛŒ Ú©Ù‡ Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯:</label>
        <div style="max-width:960px">{{ form.weights }}</div>
      </div>

      <div class="mn-actions">
        <label>{{ form.reset_old }} Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ</label>
        <label>{{ form.do_apply }} Ø§Ø¹Ù…Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ</label>
        <button type="submit" class="button default">Ø§Ø¬Ø±Ø§</button>
      </div>
      <p class="byetip">ØªÙˆØ¬Ù‡: Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Â«Ø§Ø³ØªØ±Ø§Ø­ØªÂ» Ø´Ù…Ø§Ø±Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
    </form>

    {% if mats_map %}
      <div class="mn-result">
        <strong>Ù†Ù‚Ø´Ù‡Ù” Ø²Ù…ÛŒÙ†â€ŒÙ‡Ø§:</strong>
        <ul>
          {% for mat, ws in mats_map %}
            <li>Ø²Ù…ÛŒÙ† {{ mat }} â†’ {{ ws|join:"ØŒ " }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

   {% if selected_competition_id %}
  <div class="mn-actions" style="justify-content:flex-end; gap:8px; margin-top:10px;">
    <form method="post" action="{% url 'admin:competitions_match_numbering_publish' %}" style="display:inline;">
      {% csrf_token %}
      <input type="hidden" name="competition" value="{{ selected_competition_id }}">
      <button type="submit" class="button default">Ø§Ù†ØªØ´Ø§Ø± Ø¬Ø¯ÙˆÙ„</button>
    </form>
    <form method="post" action="{% url 'admin:competitions_match_numbering_publish' %}?unpublish=1" style="display:inline;">
      {% csrf_token %}
      <input type="hidden" name="competition" value="{{ selected_competition_id }}">
      <button type="submit" class="button" title="Ù¾Ù†Ù‡Ø§Ù†â€ŒØ³Ø§Ø²ÛŒ Ø§Ø² Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±">Ù„ØºÙˆ Ø§Ù†ØªØ´Ø§Ø±</button>
    </form>
    {% if is_bracket_published %}
      <span class="byetic">ÙˆØ¶Ø¹ÛŒØª: Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡</span>
    {% else %}
      <span class="byetid">ÙˆØ¶Ø¹ÛŒØª: Ù…Ù†ØªØ´Ø± Ù†ÛŒØ³Øª</span>
    {% endif %}
  </div>
{% endif %}


    {% if brackets and brackets|length %}
      <div class="pd-toolbar" id="pd-toolbar">
        <button type="button" class="button outline" id="btn-dl-all">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù‡Ù…Ù‡ ØªØµØ§ÙˆÛŒØ±</button>
      </div>

      <div class="cards">
        {% for p in brackets %}
          <div class="card"
               data-title="{{ p.title|escapejs }}"
               data-belt="{{ p.belt|escapejs }}"
               data-weight="{{ p.weight|escapejs }}"
               data-date="{{ p.date_j|escapejs }}">
            <div class="card-content">
              <div class="hd">
                <div class="left">
                  <span class="pill">{{ p.title }}</span>
                  <span class="pill">Ø±Ø¯Ù‡ Ú©Ù…Ø±Ø¨Ù†Ø¯ÛŒ: {{ p.belt }}</span>
                  <span class="pill">Ø±Ø¯Ù‡Ù” ÙˆØ²Ù†ÛŒ: {{ p.weight }}</span>
                  <span class="pill">Ø²Ù…ÛŒÙ†: <b class="mat-no" data-weight="{{ p.weight|escapejs }}">{{ p.mat_no|default:"â€”" }}</b></span>
                  <span class="pill">ØªØ§Ø±ÛŒØ®: {{ p.date_j }}</span>
                </div>
                {% if board_logo_url %}
                  <img class="brand-logo" src="{{ board_logo_url }}" alt="Ù„ÙˆÚ¯ÙˆÛŒ Ù‡ÛŒØ¦Øª" crossorigin="anonymous">
                {% endif %}
              </div>

              <div class="bd">
                <div class="bracket-wrap" data-size='{{ p.size }}'>
                  <div class="view">
                    <div class="board">
                      <div class="col r1"><div class="stack">{% for i in "0123456789abcdef" %}
                        <div class="item"><input class="player-input" data-r="1" data-i="{{ forloop.counter0 }}" data-pos="a" readonly></div>
                        <div class="item">
                          <input class="player-input" data-r="1" data-i="{{ forloop.counter0 }}" data-pos="b" readonly>
                          <input class="bubble" data-r="1" data-i="{{ forloop.counter0 }}" data-num readonly style="right:-28px;">
                        </div>
                      {% endfor %}</div></div>

                      <div class="col r2"><div class="stack">{% for i in "01234567" %}
                        <div class="item"><input class="player-input" data-r="2" data-i="{{ forloop.counter0 }}" data-pos="a" readonly></div>
                        <div class="item">
                          <input class="player-input" data-r="2" data-i="{{ forloop.counter0 }}" data-pos="b" readonly>
                          <input class="bubble" data-r="2" data-i="{{ forloop.counter0 }}" data-num readonly style="right:-28px;">
                        </div>
                      {% endfor %}</div></div>

                      <div class="col r3"><div class="stack">{% for i in "0123" %}
                        <div class="item"><input class="player-input" data-r="3" data-i="{{ forloop.counter0 }}" data-pos="a" readonly></div>
                        <div class="item">
                          <input class="player-input" data-r="3" data-i="{{ forloop.counter0 }}" data-pos="b" readonly>
                          <input class="bubble" data-r="3" data-i="{{ forloop.counter0 }}" data-num readonly style="right:-28px;">
                        </div>
                      {% endfor %}</div></div>

                      <div class="col r4"><div class="stack">{% for i in "01" %}
                        <div class="item"><input class="player-input" data-r="4" data-i="{{ forloop.counter0 }}" data-pos="a" readonly></div>
                        <div class="item">
                          <input class="player-input" data-r="4" data-i="{{ forloop.counter0 }}" data-pos="b" readonly>
                          <input class="bubble" data-r="4" data-i="{{ forloop.counter0 }}" data-num readonly style="right:-28px;">
                        </div>
                      {% endfor %}</div></div>

                      <div class="col r5"><div class="stack">
                        <div class="item"><input class="player-input" data-r="5" data-i="0" data-pos="a" readonly></div>
                        <div class="item">
                          <input class="player-input" data-r="5" data-i="0" data-pos="b" readonly>
                          <input class="bubble" data-r="5" data-i="0" data-num readonly style="right:-18px;">
                        </div>
                      </div></div>

                      <div class="col r6"><div class="champ"><input class="player-input" value="ğŸ†                      " readonly></div></div>
                    </div>
                  </div>

                  <script type="application/json" class="matches-json">
                    {{ p.matches_json|safe }}
                  </script>
                </div><!-- /bracket-wrap -->
              </div>
            </div><!-- /card-content -->

            <img class="card-snapshot" alt="Bracket snapshot">

            <div class="snapshot-overlay" aria-hidden="true">
              <div class="spinner"></div>
              <div class="wait-label">Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øªâ€¦</div>
            </div>

            <div class="card-controls">
              <button type="button" class="button default dl-one">Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±</button>
              <span class="err"></span>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <script>
  (function () {
    const DPR = Math.min(1.6, Math.max(1, window.devicePixelRatio || 1));

    const form = document.getElementById('mn-form');
    const compSel = document.getElementById('id_competition');
    if (compSel && form) {
      compSel.addEventListener('change', function () {
        const doApply = document.getElementById('id_do_apply');
        if (doApply) doApply.checked = false;
        form.submit();
      });
    }

    /* ----- Map Ø²Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ø§Ø² Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ ----- */
    const MatsByWeight = new Map([
      {% if mats_map %}{% for mat, ws in mats_map %}{% for w in ws %}
        ["{{ w|escapejs }}","{{ mat }}"],
      {% endfor %}{% endfor %}{% endif %}
    ]);
    document.querySelectorAll('.mat-no').forEach(el=>{
      const w = el.getAttribute('data-weight');
      if (w && MatsByWeight.has(w)) el.textContent = MatsByWeight.get(w);
    });

    /* ====== ØªÙˆØ§Ø¨Ø¹ Ø¨Ø±Ø¯/ÙÛŒØª ====== */
    function applyRoundShifting(wrap, declaredSize){
      const size = Math.max(1, Number(declaredSize||0));
      let roundsCount = 0; while ((1<<roundsCount) < size) roundsCount++;
      roundsCount = Math.max(1, roundsCount);
      const SHIFT = 5 - roundsCount;
      for (let c=1; c<=5; c++){
        const col = wrap.querySelector('.r'+c);
        if (col) col.style.display = (c < (SHIFT+1)) ? 'none' : '';
      }
      const mapRound = r => r + SHIFT;
      return { mapRound };
    }

    function readMatches(wrap){
      const node = wrap.querySelector('script.matches-json');
      const txt = node ? (node.textContent||'').trim() : '';
      if (!txt) return [];
      try { return JSON.parse(txt); } catch { return []; }
    }

    function fitToCard(wrap){
      const view  = wrap.querySelector('.view');
      const board = wrap.querySelector('.board');
      if (!view || !board) return;
      board.style.transform = 'scale(1)';
      const pad = 6, naturalW = board.scrollWidth + pad, naturalH = board.scrollHeight + pad;
      const vw = view.clientWidth, vh = view.clientHeight;
      const scale = Math.min(vw/naturalW, vh/naturalH);
      board.style.setProperty('--scale', Math.max(0, Math.min(1, scale)).toFixed(3));
      board.style.transform = '';
    }
    function refitAll(){ document.querySelectorAll('.bracket-wrap').forEach(fitToCard); }

    const isRest   = v => String(v||'').trim()==='Ø§Ø³ØªØ±Ø§Ø­Øª';
    const nonEmpty = v => String(v||'').trim() !== '';
    function put(el, val){ if(!el) return; el.value = val || ""; el.title = el.value; if(isRest(el.value)) el.classList.add("bye"); else el.classList.remove("bye"); }

    function getMatchNumber(m){
      return m.match_number ?? m.number ?? m.number_on_mat ?? m.seq_no ?? m.seq ?? m.order_on_mat ?? m.order ?? "";
    }

    function firstRoundInfo(wrap, mapRound){
      for (let r=1; r<=5; r++){
        const vr = mapRound(r);
        const count = wrap.querySelectorAll(`input.player-input[data-r="${vr}"][data-pos="a"]`).length;
        if (count > 0) return { r, vr, count };
      }
      return { r:null, vr:null, count:0 };
    }

    function propagateByesOneStep(wrap, mapRound){
      const info = firstRoundInfo(wrap, mapRound);
      if (!info.r) return;
      const r = info.r, vr = info.vr, count = info.count;

      for (let i=0; i<count; i++){
        const a = wrap.querySelector(`input.player-input[data-r="${vr}"][data-i="${i}"][data-pos="a"]`);
        const b = wrap.querySelector(`input.player-input[data-r="${vr}"][data-i="${i}"][data-pos="b"]`);
        const n = wrap.querySelector(`input.bubble[data-r="${vr}"][data-i="${i}"][data-num]`);

        const restPair = (isRest(a?.value) ^ isRest(b?.value));
        if (restPair && n){ n.classList.add('bye-mark'); n.value=""; n.title="Ø§Ø³ØªØ±Ø§Ø­Øª"; }

        const hasA = a && nonEmpty(a.value) && !isRest(a.value);
        const hasB = b && nonEmpty(b.value) && !isRest(b.value);
        if (!( (hasA && isRest(b?.value)) || (hasB && isRest(a?.value)) )) continue;

        const winner = hasA ? a.value : b.value;
        const nextVr = mapRound(r+1);
        if (!wrap.querySelector(`input.player-input[data-r="${nextVr}"]`)) continue;
        const nextI = Math.floor(i/2);
        const nextPos = (i % 2 === 0) ? 'a' : 'b';
        const nxt = wrap.querySelector(`input.player-input[data-r="${nextVr}"][data-i="${nextI}"][data-pos="${nextPos}"]`);
        if (nxt && (!nonEmpty(nxt.value) || isRest(nxt.value))) put(nxt, winner);
      }
    }

    /* --- Ø­Ø§Ù„Øª ØªÚ©â€ŒÙ†ÙØ±Ù‡: Ù‡Ù…Ù‡ Ù…Ø³ÛŒØ±Ù‡Ø§ Ø§Ø³ØªØ±Ø§Ø­Øª Ùˆ Ø¨Ø¯ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡ --- */
    function detectSinglePlayerName(matches){
      const s = new Set();
      for (const m of matches){
        const a = (m.player_a||'').trim(); if (a && a!=='Ø§Ø³ØªØ±Ø§Ø­Øª') s.add(a);
        const b = (m.player_b||'').trim(); if (b && b!=='Ø§Ø³ØªØ±Ø§Ø­Øª') s.add(b);
      }
      return s.size===1 ? [...s][0] : '';
    }

    function fillSinglePathAllTheWay(wrap, name, mapRound, firstInfo){
      if (!name || !firstInfo || !firstInfo.r) return;

      // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¬ÙØª Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¯Ø± Ø±Ø§Ù†Ø¯ Ø§ÙˆÙ„
      let i = 0;
      for (let idx=0; idx<firstInfo.count; idx++){
        const a = wrap.querySelector(`input.player-input[data-r="${firstInfo.vr}"][data-i="${idx}"][data-pos="a"]`);
        const b = wrap.querySelector(`input.player-input[data-r="${firstInfo.vr}"][data-i="${idx}"][data-pos="b"]`);
        if (a?.value.trim()===name || b?.value.trim()===name){ i = idx; break; }
      }

      // Ø±Ø§Ù†Ø¯ Ø§ÙˆÙ„: Ù‡Ù…Ù‡ Â«Ø§Ø³ØªØ±Ø§Ø­ØªÂ»Ø› Ø¬ÙØª Ø¨Ø§Ø²ÛŒÚ©Ù†: ÛŒÚ© Ø·Ø±Ù Ø¨Ø§Ø²ÛŒÚ©Ù† / Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªØ±Ø§Ø­Øª
      for (let idx=0; idx<firstInfo.count; idx++){
        const a = wrap.querySelector(`input.player-input[data-r="${firstInfo.vr}"][data-i="${idx}"][data-pos="a"]`);
        const b = wrap.querySelector(`input.player-input[data-r="${firstInfo.vr}"][data-i="${idx}"][data-pos="b"]`);
        const n = wrap.querySelector(`input.bubble[data-r="${firstInfo.vr}"][data-i="${idx}"][data-num]`);
        if (idx === i){
          const aIs = a?.value.trim()===name;
          if (aIs){ if (b){ b.value="Ø§Ø³ØªØ±Ø§Ø­Øª"; b.classList.add('bye'); } }
          else { if (a){ a.value="Ø§Ø³ØªØ±Ø§Ø­Øª"; a.classList.add('bye'); } if (b){ b.value=name; b.classList.remove('bye'); } }
        }else{
          if (a){ a.value="Ø§Ø³ØªØ±Ø§Ø­Øª"; a.classList.add('bye'); }
          if (b){ b.value="Ø§Ø³ØªØ±Ø§Ø­Øª"; b.classList.add('bye'); }
        }
        if (n){ n.classList.add('bye-mark'); n.value=""; n.title="Ø§Ø³ØªØ±Ø§Ø­Øª"; }
      }

      // Ø§Ø² Ù‡Ù…Ø§Ù† Ø´Ø§Ø®Ù‡ØŒ Ù†Ø§Ù… Ø±Ø§ ØªØ§ ÙÛŒÙ†Ø§Ù„ Ø¨Ø§Ù„Ø§ Ø¨Ø¨Ø±Ø› Ù‡Ù…Ù‡ Ø­Ø¨Ø§Ø¨â€ŒÙ‡Ø§ Ø¨Ø¯ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡
      let r = firstInfo.r;
      while (true){
        const vr = mapRound(r);
        const a = wrap.querySelector(`input.player-input[data-r="${vr}"][data-i="${i}"][data-pos="a"]`);
        const b = wrap.querySelector(`input.player-input[data-r="${vr}"][data-i="${i}"][data-pos="b"]`);
        const n = wrap.querySelector(`input.bubble[data-r="${vr}"][data-i="${i}"][data-num]`);
        if (!a || !b) break;

        if (!a.value || a.value==="Ø§Ø³ØªØ±Ø§Ø­Øª"){ a.value=name; a.classList.remove('bye'); b.value="Ø§Ø³ØªØ±Ø§Ø­Øª"; b.classList.add('bye'); }
        else { b.value="Ø§Ø³ØªØ±Ø§Ø­Øª"; b.classList.add('bye'); }
        if (n){ n.classList.add('bye-mark'); n.value=""; n.title="Ø§Ø³ØªØ±Ø§Ø­Øª"; }

        const nextVr = mapRound(r+1);
        if (!wrap.querySelector(`input.player-input[data-r="${nextVr}"]`)) break;

        const nextI = Math.floor(i/2);
        const nextPos = (i % 2 === 0) ? 'a' : 'b';
        const nxt = wrap.querySelector(`input.player-input[data-r="${nextVr}"][data-i="${nextI}"][data-pos="${nextPos}"]`);
        const nxtOpp = wrap.querySelector(`input.player-input[data-r="${nextVr}"][data-i="${nextI}"][data-pos="${nextPos==='a'?'b':'a'}"]`);
        if (nxt){ nxt.value = name; nxt.classList.remove('bye'); nxt.title = name; }
        if (nxtOpp){ nxtOpp.value = "Ø§Ø³ØªØ±Ø§Ø­Øª"; nxtOpp.classList.add('bye'); }

        i = nextI; r += 1;
      }

      const champ = wrap.querySelector('.r6 .champ .player-input');
      if (champ){ champ.value = `ğŸ†  ${name}`; champ.title = name; }
    }

    function applyDataAndFit(wrap){
      const matches = readMatches(wrap);
      const declaredSize = wrap.getAttribute('data-size') || '';
      const { mapRound } = applyRoundShifting(wrap, declaredSize);
      const fr = firstRoundInfo(wrap, mapRound);

      if (matches.length){
        const byRound = new Map();
        for (const m of matches){
          const r = Number(m.round_no || 1);
          if (!byRound.has(r)) byRound.set(r, []);
          byRound.get(r).push(m);
        }
        for (const [r, arr] of byRound) arr.sort((a,b)=>(a.slot_a||0)-(b.slot_a||0));

        for (const [r, arr] of byRound){
          const vr = mapRound(r);
          const isFirstRound = (vr === fr.vr);

          arr.forEach((m, idx)=>{
            const a = wrap.querySelector(`input.player-input[data-r="${vr}"][data-i="${idx}"][data-pos="a"]`);
            const b = wrap.querySelector(`input.player-input[data-r="${vr}"][data-i="${idx}"][data-pos="b"]`);
            const n = wrap.querySelector(`input.bubble[data-r="${vr}"][data-i="${idx}"][data-num]`);

            const hasA = nonEmpty(m.player_a);
            const hasB = nonEmpty(m.player_b);

            if (a){ put(a, hasA ? m.player_a : ((hasB && m.is_bye && isFirstRound) ? "Ø§Ø³ØªØ±Ø§Ø­Øª" : a.value)); }
            if (b){ put(b, hasB ? m.player_b : ((hasA && m.is_bye && isFirstRound) ? "Ø§Ø³ØªØ±Ø§Ø­Øª" : b.value)); }

            if (n) {
              const restPair = isFirstRound && (isRest(a?.value) ^ isRest(b?.value));
              if (restPair) { n.classList.add('bye-mark'); n.value = ""; n.title = "Ø§Ø³ØªØ±Ø§Ø­Øª"; }
              else { n.classList.remove('bye-mark'); n.value = String(getMatchNumber(m) || ""); n.title = n.value; }
            }
          });
        }
      }

      const singleName = detectSinglePlayerName(matches);
      if (singleName) fillSinglePathAllTheWay(wrap, singleName, mapRound, fr);
      else propagateByesOneStep(wrap, mapRound);

      fitToCard(wrap);
    }

    /* ====== ÙÛŒØª Ù‡Ø¯Ø± (ÛŒÚ©â€ŒØ®Ø·ÛŒ Ø¨Ø§ Ø§Ø³Ú©ÛŒÙ„) ====== */
    function fitHeader(card){
      const hd = card.querySelector('.hd'); if (!hd) return;
      const left = hd.querySelector('.left'); const logo = hd.querySelector('.brand-logo');
      const avail = hd.clientWidth - (logo?.offsetWidth || 0) - 24;
      const need = left.scrollWidth;
      let scale = 1; if (need > avail) scale = Math.max(0.85, Math.min(1, avail / need));
      card.style.setProperty('--hdrScale', scale.toFixed(3));
    }
    function fitAllHeaders(){ document.querySelectorAll('.card').forEach(fitHeader); }

    /* ====== Snapshot: Ú©Ù„ Ú©Ø§Ø±Øª â†’ PNG ====== */
    function filenameFromCard(card){
      const title = (card.dataset.title||'').trim();
      const belt  = (card.dataset.belt||'').trim();
      const w     = (card.dataset.weight||'').trim();
      const date  = (card.dataset.date||'').trim();
      const mat   = (card.querySelector('.mat-no')?.textContent || 'â€”').trim();
      const slug = s => s.replace(/\s+/g,'-').replace(/[^\u0600-\u06FF\w\-]+/g,'').replace(/\-+/g,'-').replace(/^\-+|\-+$/g,'') || 'bracket';
      return `${slug(title)}-${slug(belt)}-${slug(w)}-${slug(mat)}${date?'-'+slug(date):''}.png`;
    }

    async function snapshotCard(card){
      const lib = window.htmlToImage;
      if (!lib || !lib.toPng) return;
      const srcNode = card.querySelector('.card-content'); if (!srcNode) return;

      card.classList.add('is-rendering');
      await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
      try { if (document.fonts?.ready) await document.fonts.ready; } catch {}

      fitHeader(card);

      try{
        const dataUrl = await lib.toPng(srcNode, {
          pixelRatio: DPR, backgroundColor: '#fff', cacheBust: true,
          filter: (n) => {
            if (n?.classList?.contains?.('snapshot-overlay')) return false;
            return true;
          }
        });
        const img = card.querySelector('.card-snapshot');
        img.src = dataUrl;
        img.setAttribute('data-filename', filenameFromCard(card));
        card.classList.add('is-snap');
      }catch(e){
        card.querySelector('.card-controls .err')?.replaceChildren(document.createTextNode('Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ± Ù†Ø§Ù…ÙˆÙÙ‚ (CORS ÛŒØ§ DOM Ø³Ù†Ú¯ÛŒÙ†).'));
      }finally{
        card.classList.remove('is-rendering');
      }
    }

    function snapshotAll(){
      document.querySelectorAll('.card').forEach(snapshotCard);
    }

    /* ====== Ø¯Ø§Ù†Ù„ÙˆØ¯ ====== */
    function downloadOne(card){
      const img = card.querySelector('.card-snapshot'); if (!img?.src) return;
      const a = document.createElement('a');
      a.href = img.src;
      a.download = img.getAttribute('data-filename') || filenameFromCard(card);
      document.body.appendChild(a); a.click(); a.remove();
    }

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.dl-one');
      if (btn){
        const card = btn.closest('.card'); if (card) downloadOne(card);
      }
    });

    const btnDlAll = document.getElementById('btn-dl-all');
    if (btnDlAll){
      btnDlAll.addEventListener('click', ()=>{
        document.querySelectorAll('.card').forEach(downloadOne);
      });
    }

    /* ====== Ø§Ø¬Ø±Ø§ ====== */
    document.querySelectorAll('.bracket-wrap').forEach(applyDataAndFit);
    fitAllHeaders();
    setTimeout(()=>{ fitAllHeaders(); snapshotAll(); }, 160);
    let t; window.addEventListener('resize', ()=>{ clearTimeout(t); t=setTimeout(()=>{ refitAll(); fitAllHeaders(); }, 120); });
  })();
  </script>
{% endblock %}
